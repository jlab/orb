params {
    reads = "/vol/jlab/tlin/marbel_benchmarking_integration/samplesheets_eval/dataset1.csv"
    contigs = "/vol/jlab/tlin/all_project/nf_results/assembler_benchmark_pipeline/dataset1/assembler/dataset1/*.fa"
    reference_cds = "/vol/jlab/tlin/marbel_benchmarking_integration/dataset1/summary/metatranscriptome_reference.fasta"
    outdir = "test"

}

process {
    executor = 'slurm'
    queue = 'bcf'
    cpus = 32
    memory = '32G'
    queueSize = 300
    time = '20h'
    errorStrategy = { task.attempt <= 2 ? 'retry' : 'finish' }
    maxRetries = 2

    beforeScript = """
        var=/var/scratch/\$USER/process_tmp_\$(date +%s%N)\$RANDOM
        echo $USER >> log.txt
        echo \$var > podman_dir.txt
        mkdir -p \$var/podman
        #podman system reset -f
        #podman system migrate
        export XDG_RUNTIME_DIR=\$var/podman
        export TMPDIR=\$var
        export http_proxy=http://192.168.10.1:3128
        export https_proxy=http://192.168.10.1:3128
        export ftp_proxy=http://192.168.10.1:3128
    """

     afterScript = """
        var=\$(cat podman_dir.txt)
        echo \$var
        rm -rf \$var
    """


    withName: SALMON_QUANT {
        memory = '32G'
        cpus = 32
    }

    withName: MINIMAP2_MAP {
        cpus = 50
        memory = '50G'
    }

}

podman {
    runOptions = '--group-add keep-groups --cgroup-manager=cgroupfs --volume=/homes/tlin/Projects/refbasedassemblereval/bin/minimap2_deduplicate.py:/container/bin/minimap2_deduplicate.py'
}
